<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Anonymous Chat - Supabase</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      height: -webkit-fill-available;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      position: fixed;
      width: 100%;
      height: 100%;
      height: -webkit-fill-available;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      background: white;
      height: 100%;
      height: -webkit-fill-available;
      overflow: hidden;
    }

    .chat-header {
      background: #667eea;
      color: white;
      padding: 12px 16px;
      text-align: center;
      flex-shrink: 0;
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .active-users {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 400;
    }

    .status {
      padding: 4px 16px;
      text-align: center;
      font-size: 10px;
      color: #666;
      background: #f0f0f0;
      flex-shrink: 0;
      display: none;
    }

    .status.connected {
      display: none;
    }

    .status.disconnected {
      display: block;
      background: #ffe6e6;
      color: #d32f2f;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f5f5f5;
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }

    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      word-wrap: break-word;
      animation: slideIn 0.2s ease-out;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.own {
      align-self: flex-end;
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.other {
      align-self: flex-start;
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message-text {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 2px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .message-time {
      font-size: 10px;
      opacity: 0.6;
      text-align: right;
      margin-top: 2px;
    }

    .message-sender {
      font-size: 11px;
      opacity: 0.8;
      text-align: right;
      margin-top: 2px;
      font-weight: 500;
    }

    .input-container {
      display: flex;
      padding: 10px 12px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: white;
      gap: 8px;
      border-top: 1px solid #e0e0e0;
      flex-shrink: 0;
      position: relative;
      z-index: 100;
      align-items: flex-end;
    }

    .input-container textarea {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 16px;
      font-family: inherit;
      resize: none;
      max-height: 100px;
      min-height: 40px;
      outline: none;
      transition: border-color 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    .input-container textarea:focus {
      border-color: #667eea;
    }

    .input-container button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
      min-width: 60px;
      -webkit-tap-highlight-color: transparent;
    }

    .input-container button:active:not(:disabled) {
      background: #5568d3;
    }

    .input-container button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #ccc;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .chat-container {
        max-width: 100%;
        height: 100vh;
        height: -webkit-fill-available;
      }

      .chat-header {
        padding: 10px 12px;
      }

      .chat-header h1 {
        font-size: 16px;
      }

      .active-users {
        font-size: 11px;
      }

      .messages-container {
        padding: 10px;
        gap: 6px;
      }

      .message {
        max-width: 85%;
        padding: 8px 12px;
      }

      .message-text {
        font-size: 14px;
      }

      .message-time {
        font-size: 9px;
      }

      .input-container {
        padding: 8px 10px;
        padding-bottom: max(8px, env(safe-area-inset-bottom));
      }

      .input-container textarea {
        font-size: 16px;
        padding: 8px 12px;
        min-height: 36px;
      }

      .input-container button {
        padding: 8px 16px;
        font-size: 14px;
        min-width: 55px;
      }
    }

    @media screen and (max-width: 768px) {
      input, textarea, select {
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>üí¨ Anonymous Chat</h1>
      <div class="active-users" id="activeUsers">Loading...</div>
    </div>
    
    <div class="status" id="status">Connecting...</div>
    
    <div class="messages-container" id="messagesContainer">
      <div class="loading">Loading messages...</div>
    </div>

    <div class="input-container">
      <textarea 
        id="messageInput" 
        placeholder="Type a message..." 
        maxlength="2000"
        rows="1"
      ></textarea>
      <button id="sendButton" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Supabase Client -->
  <script type="module">
    // Import Supabase
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
    // Indian names list (100+ names)
    const indianNames = [
      "Arjun", "Priya", "Rohan", "Ananya", "Karan", "Sneha", "Vikram", "Kavya", "Rohan", "Divya",
      "Aditya", "Meera", "Siddharth", "Isha", "Aryan", "Pooja", "Krishna", "Anjali", "Ravi", "Neha",
      "Vishal", "Shreya", "Amit", "Riya", "Raj", "Sakshi", "Nikhil", "Tanvi", "Sahil", "Aishwarya",
      "Rohit", "Kritika", "Varun", "Aditi", "Akash", "Swati", "Harsh", "Pallavi", "Yash", "Nisha",
      "Manish", "Deepika", "Gaurav", "Shruti", "Abhishek", "Ankita", "Suresh", "Jyoti", "Prateek", "Richa",
      "Kunal", "Monika", "Ankit", "Sonal", "Vivek", "Preeti", "Rishabh", "Kiran", "Mohit", "Radha",
      "Sachin", "Vidya", "Naveen", "Lakshmi", "Dinesh", "Geeta", "Pankaj", "Sarika", "Aman", "Madhuri",
      "Ritesh", "Sunita", "Nitin", "Poonam", "Sandeep", "Rekha", "Ashish", "Manju", "Deepak", "Suman",
      "Vijay", "Kamala", "Sanjay", "Uma", "Ajay", "Leela", "Manoj", "Padma", "Sunil", "Indira",
      "Rajesh", "Lata", "Mahesh", "Sita", "Vinod", "Ganga", "Bharat", "Saraswati", "Gopal", "Durga",
      "Shyam", "Parvati", "Ram", "Lakshmi", "Krishna", "Radha", "Shiva", "Kali", "Vishnu", "Saraswati",
      "Ganesh", "Lakshmi", "Hanuman", "Durga", "Brahma", "Parvati", "Indra", "Sita", "Yama", "Ganga"
    ];

    // Get or generate user name from localStorage
    function getUserName() {
      let userName = localStorage.getItem("chatUserName");
      if (!userName) {
        userName = indianNames[Math.floor(Math.random() * indianNames.length)];
        localStorage.setItem("chatUserName", userName);
      }
      return userName;
    }

    // Initialize Supabase
    const SUPABASE_URL = window.SUPABASE_URL || "https://pvxhsqgsxrolgbbnzsyp.supabase.co";
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2eGhzcWdzeHJvbGdiYm56c3lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMjMxODksImV4cCI6MjA4MTY5OTE4OX0.jswK57zrWHKPoyeDjeErrPnfkQT5WYfJsto4HtuVwCY";

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      document.body.innerHTML = `
        <div style="padding: 20px; text-align: center;">
          <h2>‚ö†Ô∏è Configuration Required</h2>
          <p>Please set your Supabase credentials:</p>
          <ol style="text-align: left; max-width: 500px; margin: 20px auto;">
            <li>Create a free account at <a href="https://supabase.com">supabase.com</a></li>
            <li>Create a new project</li>
            <li>Run the SQL schema from <code>supabase/schema.sql</code></li>
            <li>Get your URL and Anon Key from Settings ‚Üí API</li>
            <li>Add them to this file or set as environment variables</li>
          </ol>
          <p>See <code>SUPABASE_SETUP.md</code> for detailed instructions.</p>
        </div>
      `;
      throw new Error("Supabase credentials not configured");
    }

    // Create Supabase client
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let isConnected = false;
    let messageCount = 0;
    let activeUsersCount = 0;
    const myUserName = getUserName();

    // Initialize
    async function initialize() {
      updateStatus("Connecting...", "disconnected");
      
      try {
        // Load existing messages
        await loadMessages();
        
        // Subscribe to new messages
        subscribeToMessages();
        
        // Track active users via presence
        trackPresence();
        
        isConnected = true;
        updateStatus("Connected", "connected");
        hideLoading();
      } catch (error) {
        console.error("Initialization error:", error);
        updateStatus("Connection failed. Check console.", "disconnected");
      }
    }

    // Load messages from Supabase
    async function loadMessages() {
      try {
        const { data, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('created_at', { ascending: true })
          .limit(10000);

        if (error) throw error;

        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";

        if (data && data.length > 0) {
          data.forEach((msg) => {
            addMessageToUI(formatMessage(msg), false);
          });
          scrollToBottom();
        }
      } catch (error) {
        console.error("Error loading messages:", error);
        updateStatus("Failed to load messages", "disconnected");
      }
    }

    // Format message for display
    function formatMessage(msg) {
      const date = new Date(msg.created_at);
      return {
        id: msg.id,
        text: msg.text,
        sender: msg.sender,
        date: date.toLocaleDateString(),
        time: date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
        timestamp: date.getTime(),
      };
    }

    // Subscribe to new messages via Realtime
    function subscribeToMessages() {
      supabaseClient
        .channel('messages')
        .on('postgres_changes', 
          { event: 'INSERT', schema: 'public', table: 'messages' },
          (payload) => {
            console.log('New message received:', payload.new);
            addMessageToUI(formatMessage(payload.new), true);
            scrollToBottom();
          }
        )
        .subscribe();
    }

    // Track active users via presence
    function trackPresence() {
      const channel = supabaseClient.channel('online-users');
      
      channel
        .on('presence', { event: 'sync' }, () => {
          const state = channel.presenceState();
          activeUsersCount = Object.keys(state).length;
          updateActiveUsersDisplay();
        })
        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
          activeUsersCount = Object.keys(channel.presenceState()).length;
          updateActiveUsersDisplay();
        })
        .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
          activeUsersCount = Object.keys(channel.presenceState()).length;
          updateActiveUsersDisplay();
        })
        .subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            await channel.track({ user: myUserName, online_at: new Date().toISOString() });
          }
        });
    }

    // Send message
    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();

      if (!text || !isConnected) return;

      try {
        const { data, error } = await supabaseClient
          .from('messages')
          .insert([
            {
              text: text,
              sender: myUserName,
            }
          ])
          .select()
          .single();

        if (error) throw error;

        input.value = "";
        autoResizeTextarea(input);
      } catch (error) {
        console.error("Error sending message:", error);
        alert("Failed to send message. Please try again.");
      }
    }

    // Add message to UI
    function addMessageToUI(msg, animate = true) {
      const container = document.getElementById("messagesContainer");
      const messageDiv = document.createElement("div");
      
      const isOwn = msg.sender === myUserName;
      messageCount++;
      
      messageDiv.className = `message ${isOwn ? "own" : "other"}`;
      messageDiv.style.animation = animate ? "slideIn 0.2s ease-out" : "none";

      messageDiv.innerHTML = `
        <div class="message-text">${escapeHtml(msg.text)}</div>
        <div class="message-time">${msg.date} ‚Ä¢ ${msg.time}</div>
        <div class="message-sender">${escapeHtml(msg.sender)}</div>
      `;

      container.appendChild(messageDiv);
    }

    // Utility functions
    function updateStatus(text, className) {
      const status = document.getElementById("status");
      if (status) {
        status.textContent = text;
        status.className = `status ${className}`;
      }
    }

    function updateActiveUsersDisplay() {
      const activeUsersEl = document.getElementById("activeUsers");
      if (activeUsersEl) {
        activeUsersEl.textContent = `${activeUsersCount} ${activeUsersCount === 1 ? 'user' : 'users'} online`;
      }
    }

    function hideLoading() {
      const loading = document.querySelector(".loading");
      if (loading) {
        loading.remove();
      }
    }

    function scrollToBottom() {
      const container = document.getElementById("messagesContainer");
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function autoResizeTextarea(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = Math.min(textarea.scrollHeight, 100) + "px";
    }

    // Event listeners
    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.getElementById("messageInput").addEventListener("input", function() {
      autoResizeTextarea(this);
    });

    // Mobile keyboard handling
    const messageInput = document.getElementById("messageInput");
    messageInput.addEventListener("focus", () => {
      document.body.style.overflow = "hidden";
      setTimeout(() => {
        document.querySelector(".input-container").scrollIntoView({ behavior: "smooth", block: "end" });
      }, 300);
    });
    
    messageInput.addEventListener("blur", () => {
      document.body.style.overflow = "";
    });

    // Initialize on page load
    initialize();

    // Auto-scroll on new messages
    const observer = new MutationObserver(() => {
      scrollToBottom();
    });

    observer.observe(document.getElementById("messagesContainer"), {
      childList: true,
    });
  </script>
</body>
</html>
